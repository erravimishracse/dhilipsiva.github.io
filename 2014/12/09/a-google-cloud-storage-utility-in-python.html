<!DOCTYPE html>
<html>
    <head>
        <title>A Google Cloud Storage Utility in python | dhilipsiva</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <meta name="title" content="A Google Cloud Storage Utility in python | dhilipsiva"/>
        <meta name="description" content=""/>
        <meta name="keywords" content="dhilipsiva"/>

        <meta property="og:type" content="article" />
        <meta property="og:title" content="A Google Cloud Storage Utility in python | dhilipsiva" />
        <meta property="og:description" content="" />
        <meta property="og:url" content="http://dhilipsiva.com/2014/12/09/a-google-cloud-storage-utility-in-python.html" />
        <meta property="fb:profile_id"   content="1627550002" />

        <meta name="twitter:title" content="A Google Cloud Storage Utility in python | dhilipsiva" />
        <meta name="twitter:description" content="" />
        <meta name="twitter:creator" content="@dhilipsiva">
        <meta name="twitter:url" content="http://dhilipsiva.com/2014/12/09/a-google-cloud-storage-utility-in-python.html" />
        <meta name="twitter:site" content="@dhilipsiva" />
        <meta name="twitter:domain" content="dhilipsiva.com" />

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://dhilipsiva.com/feed.xml">
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link type="text/css" rel="stylesheet" href="/assets/styles-52a7d08d0d2ce659aa0fc54dd2bfc641601d8f5e46acabab11392ef4f4615e43.css">
        <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>A Google Cloud Storage Utility in python - dhilipsiva</title>
<meta property="og:title" content="A Google Cloud Storage Utility in python" />
<meta name="description" content="This is a utility to PUT, GET and get data to make a signed request for Google Cloud Storage" />
<meta property="og:description" content="This is a utility to PUT, GET and get data to make a signed request for Google Cloud Storage" />
<link rel="canonical" href="http://dhilipsiva.com/2014/12/09/a-google-cloud-storage-utility-in-python.html" />
<meta property="og:url" content="http://dhilipsiva.com/2014/12/09/a-google-cloud-storage-utility-in-python.html" />
<meta property="og:site_name" content="dhilipsiva" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-12-09T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@dhilipsiva" />
<meta property="fb:admins" content="1627550002" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "A Google Cloud Storage Utility in python",
"datePublished": "2014-12-09T00:00:00+05:30",
"description": "This is a utility to PUT, GET and get data to make a signed request for Google Cloud Storage",
"url": "http://dhilipsiva.com/2014/12/09/a-google-cloud-storage-utility-in-python.html"}</script>
<!-- End Jekyll SEO tag -->

    </head>
    <body>
        <div id="wrapper">
            <div id="sidebar-wrapper">
                <ul class="sidebar-nav">
                    <li class="sidebar-brand">
                        <a class="header-letter-spacing" href="/">
                            dhilipsiva
                        </a>
                    </li>
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/profiles/">Profiles</a>
                    </li>
                    <li>
                        <a href="/technologies/">Technologies</a>
                    </li>
                    <li>
                        <a href="/experience/">Experience</a>
                    </li>
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    <li>
                        <a href="/open-source/">Open Source</a>
                    </li>
                    <li>
                        <a href="/press/">Press</a>
                    </li>
                    <li>
                        <a href="/services/">Services</a>
                    </li>
                    <li>
                        <a href="/blog/">Blog</a>
                    </li>
                    <li>
                        <a href="/testimonials/">Testimonials</a>
                    </li>
                    <li>
                        <a href="/hire-me/">Hire Me</a>
                    </li>
                    <li>
                        <a href="/resume/dhilipsiva-resume.pdf" target="_blank">Resume</a>
                    </li>
                    <!--
                    <li>
                        <a href="/job-board/">Job Board</a>
                    </li>
                    --!>
                    <li>
                        <a href="/contact-me/">Contact Me</a>
                    </li>
                    <li>
                        <a href="/credits/">Credits</a>
                    </li>
                </ul>
            </div>
            <div id="page-content-wrapper">
                <div class="content-header">
                    <a id="menu-toggle" href="#" class="btn btn-success">
                        &#9776; Menu
                    </a>
                    <h1>A Google Cloud Storage Utility in python</h1>
                    <h3></h3>
                </div>
                <div class="page-content inset">
                    <p class="meta">09 Dec 2014</p>
<a class="btn btn-success pull-right" href="/blog">← back</a>

<div class="post">
    <p>This is a utility to PUT, GET and get data to make a signed request for Google Cloud Storage</p>

<noscript><pre>#! /usr/bin/env python
# -*- coding: utf-8 -*-
# vim:fenc=utf-8
#
# Copyright © 2014 dhilipsiva &lt;dhilipsiva@gmail.com&gt;
#
# Distributed under terms of the MIT license.

&quot;&quot;&quot;
Requirements:
  pycrypto
  requests
&quot;&quot;&quot;

import base64
import datetime
import md5
import time

import requests
from Crypto.Hash import SHA256
from Crypto.PublicKey import RSA
from Crypto.Signature import PKCS1_v1_5

# Set this to the path of your service account private key file, in DER format.
#
# PyCrypto requires using the DER key format, but GCS provides key files in
# pkcs12 format. To convert between formats, you can use the provided commands
# below.
#
# The default password for p12 file is `notasecret`
#
# Given a GCS key in pkcs12 format, convert it to PEM using this command:
#   openssl pkcs12 -in path/to/key.p12 -nodes -nocerts &gt; path/to/key.pem
# Given a GCS key in PEM format, convert it to DER format using this command:
#   openssl rsa -in privatekey.pem -inform PEM -out privatekey.der -outform DER
GC_PRIVATE_KEY_PATH = &quot;privatekey.der&quot;
GC_BUCKET_NAME = &#39;bucket&#39;
GC_STORAGE_ENDPOINT = &#39;//storage.googleapis.com&#39;
GC_EMAIL_ADDRESS = &#39;1234567890abcdefghijklmnopqr@developer.gserviceaccount.com&#39;

keytext = open(GC_PRIVATE_KEY_PATH, &#39;rb&#39;).read()
key = RSA.importKey(keytext)

# Sample Usage:
# put_data(&#39;blah.txt&#39;, &#39;blah blah&#39;)
# get_data(&#39;blah.txt&#39;)


def _base64Sign(plaintext):
    &quot;&quot;&quot;
    Signs and returns a base64-encoded SHA256 digest.
    &quot;&quot;&quot;
    shahash = SHA256.new(plaintext)
    signer = PKCS1_v1_5.new(key)
    signature_bytes = signer.sign(shahash)
    return base64.b64encode(signature_bytes)


def _makeSignatureString(verb, path, content_md5, content_type, expiration):
    &quot;&quot;&quot;
    Creates the signature string for signing according to GCS docs.
    &quot;&quot;&quot;
    signature_string = (
        &#39;{verb}\n&#39;
        &#39;{content_md5}\n&#39;
        &#39;{content_type}\n&#39;
        &#39;{expiration}\n&#39;
        &#39;{resource}&#39;
    )

    return signature_string.format(
        verb=verb, content_md5=content_md5, content_type=content_type,
        expiration=expiration, resource=path)


def _makeUrl(verb, path, content_type=&#39;&#39;, content_md5=&#39;&#39;):
    &quot;&quot;&quot;
    Forms and returns the full signed URL to access GCS.
    &quot;&quot;&quot;
    path = &#39;/%s/%s&#39; % (GC_BUCKET_NAME, path)
    base_url = &#39;%s%s&#39; % (GC_STORAGE_ENDPOINT, path)
    expiration = datetime.datetime.now() + datetime.timedelta(hours=1)
    expiration = int(time.mktime(expiration.timetuple()))
    signature_string = _makeSignatureString(
        verb, path, content_md5, content_type, expiration)
    signature_signed = _base64Sign(signature_string)
    query_params = {
        &#39;GoogleAccessId&#39;: GC_EMAIL_ADDRESS,
        &#39;Expires&#39;: str(expiration),
        &#39;Signature&#39;: signature_signed,
    }
    return base_url, query_params


def get_data(file_key):
    &quot;&quot;&quot;
    Performs a GET request.
    Args:
        file_key: Key of the file you want to access as found in
            `&lt;bucket-name&gt;/&lt;file_key&gt;`
    Returns:
        An instance of requests.Response containing the HTTP response.
    &quot;&quot;&quot;

    base_url, query_params = _makeUrl(&#39;GET&#39;, file_key)
    return requests.get(&#39;https:&#39; + base_url, params=query_params)


def put_data(file_key, data, content_type=&#39;application/octet-stream&#39;):
    &quot;&quot;&quot;
    Performs a PUT request.
    Args:
        file_key: Key of the file you want to access as found in
            `&lt;bucket-name&gt;/&lt;file_key&gt;`

        content_type: The content type to assign to the upload.
        data: The file data to upload to the new file.
    Returns:
        An instance of requests.Response containing the HTTP response.
    &quot;&quot;&quot;
    md5_digest = base64.b64encode(md5.new(data).digest())
    base_url, query_params = _makeUrl(
        &#39;PUT&#39;, file_key, content_type, md5_digest)
    headers = {
        &#39;Content-Type&#39;: content_type,
        &#39;Content-MD5&#39;: md5_digest,
    }
    return requests.put(
        &#39;https:&#39; + base_url, params=query_params, headers=headers, data=data)


def get_put_params(file_key, content_type, md5_digest):
    &quot;&quot;&quot;
    Args:
        file_key: Key of the file you want to access as found in
            `&lt;bucket-name&gt;/&lt;file_key&gt;`

        content_type: The content type to assign to the upload.
        md5_digest: MD5 digest of file
    Returns:
        base_url, query_params and headers for signing the request
    &quot;&quot;&quot;
    base_url, query_params = _makeUrl(
        &#39;PUT&#39;, file_key, content_type, md5_digest)
    headers = {
        &#39;Content-Type&#39;: content_type,
        &#39;Content-MD5&#39;: md5_digest,
    }
    return base_url, query_params, headers</pre></noscript>
<script src="https://gist.github.com/dhilipsiva/3e51ccceebf4adbd535f.js"> </script>


</div>

                </div>
                <hr />
                <div class="row inset">
                    <p class="font-size-tiny ps-padding">
                        PS: All letters of the name, "dhilipsiva", are lowercased. This is NOT a typo. I prefer my name lowercased.
                        <br />
                        <br />
                        PSS: This site is PRIVACY FRIENDLY. I DO NOT track any visitor.
                    </p>
                </div>
            </div>
        </div>
        <script type="text/javascript" src="/assets/app-87740cf040077a1767660b22ad12f94b3068353d0052b5d635773350554990f5.js"></script>
    </body>
</html>
